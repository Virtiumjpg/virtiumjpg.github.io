<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song des Tages</title>
    <!-- Tailwind CSS für schnelles Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Grundstil für ein App-Gefühl */
        body {
            font-family: 'Inter', sans-serif;
            /* Verhindert das "Springen" beim Scrollen auf iOS */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Styling für die Suchleiste */
        #search-input::placeholder {
            color: #6b7280;
        }
        /* Custom Scrollbar (optional, aber schick) */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex justify-center items-start min-h-screen p-4 md:p-8">

    <!-- App-Container (Simuliert einen Handy-Bildschirm) -->
    <!-- WIRD JETZT STANDARDMÄSSIG PER JS VERSTECKT, BIS TOKEN GÜLTIG IST -->
    <div id="app-container" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl overflow-hidden hidden" style="max-height: 90vh;">
        
        <!-- Header -->
        <header class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-center text-green-400">Song des Tages</h1>
            <p id="status-message" class="text-center text-gray-400 text-sm mt-2"></p>
        </header>

        <!-- Hauptinhalt -->
        <main class="p-6">

            <!-- Such-Sektion -->
            <div id="search-section" class_="mb-6">
                <label for="search-input" class="sr-only">Suche nach einem Song...</label>
                <input type_="text" id="search-input" placeholder="Suche nach einem Song..." class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 disabled:opacity-50 disabled:cursor-not-allowed">
            </div>

            <!-- Lade-Spinner (versteckt) -->
            <div id="loading-spinner" class="hidden text-center py-10">
                <svg class="animate-spin h-8 w-8 text-green-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-400 mt-2">Suche läuft...</p>
            </div>

            <!-- Ergebnisse & Vorschläge Container -->
            <div id="content-area" class="mt-6" style="max-height: 60vh; overflow-y: auto;">
                
                <!-- Vorschläge -->
                <section id="suggestions-section" class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-3">Deine Top-Songs (letzte Woche)</h2>
                    <ul id="suggestions-list" class="space-y-3">
                        <!-- Wird per JS befüllt -->
                    </ul>
                </section>

                <!-- Suchergebnisse -->
                <section id="results-section" class="hidden">
                    <h2 class="text-lg font-semibold text-gray-300 mb-3">Suchergebnisse</h2>
                    <ul id="results-list" class="space-y-3">
                        <!-- Wird per JS befüllt -->
                    </ul>
                </section>

            </div>

        </main>
    </div>

    <!-- NEU: Token-Eingabe-Modal -->
    <div id="token-modal" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl overflow-hidden p-8">
        <h2 class="text-2xl font-bold text-center text-green-400 mb-4">Willkommen!</h2>
        <p class="text-gray-400 text-center mb-6">Um die App zu nutzen, brauchst du einen Spotify Access Token. Dieser ist ca. 1 Stunde gültig.</p>
        
        <p id="token-error-message" class="text-red-400 text-center mb-4 font-semibold"></p>

        <label for="token-input" class="text-sm font-medium text-gray-300">Spotify Access Token</label>
        <input type="password" id="token-input" placeholder="Token hier einfügen..." class="w-full mt-2 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400">
        
        <button id="save-token-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-colors">
            Speichern & Starten
        </button>

        <a href="https://alecchen.dev/spotify-refresh-token/" target="_blank" class="block w-full text-center bg-gray-700 hover:bg-gray-600 text-gray-300 py-3 px-4 rounded-lg mt-3 transition-colors text-sm">
            Neuen Token generieren (öffnet neuen Tab)
        </a>
        <p class="text-xs text-gray-500 mt-3 text-center">Wichtig: Wähle beim Generieren die Scopes `user-top-read` und `playlist-modify-private` / `playlist-modify-public` aus.</p>
    </div>

    <!-- Hinzufügen-Erfolgs-Toast (versteckt) -->
    <div id="toast-message" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300">
        Song erfolgreich hinzugefügt!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ECHTE API-INTEGRATION (WICHTIG!) ---
            
            // ENTFERNT: Der Token wird nicht mehr hard-coded, sondern aus dem localStorage geladen.
            // const ACCESS_TOKEN = "...";
            let currentAccessToken = null; // Wird aus localStorage geladen

            // Dein Playlist-Link: "https://open.spotify.com/playlist/DEINE_ID?si=..."
            // Du brauchst nur die ID (den Teil zwischen "playlist/" und dem optionalen "?")
            // FEHLERBEHEBUNG: Der ?si=... Teil wurde entfernt, da er die API-URL ungültig macht.
            const PLAYLIST_ID = "1cvLC0phoNcWVRgtVplJyx";

            // --- ENDE API-INTEGRATION ---

            // DOM-Elemente
            const statusMessage = document.getElementById('status-message');
            const searchInput = document.getElementById('search-input');
            const suggestionsList = document.getElementById('suggestions-list');
            const resultsSection = document.getElementById('results-section');
            const resultsList = document.getElementById('results-list');
            const suggestionsSection = document.getElementById('suggestions-section');
            const loadingSpinner = document.getElementById('loading-spinner');
            const toastMessage = document.getElementById('toast-message');
            const contentArea = document.getElementById('content-area');

            // NEUE DOM-Elemente für das Token-Modal
            const appContainer = document.getElementById('app-container');
            const tokenModal = document.getElementById('token-modal');
            const tokenInput = document.getElementById('token-input');
            const saveTokenBtn = document.getElementById('save-token-btn');
            const tokenErrorMessage = document.getElementById('token-error-message');

            // --- MOCK-DATEN (Ersatz für echte API-Aufrufe) ---
            // Entfernt, da wir jetzt die echte API nutzen
            // const mockSuggestions = [ ... ];
            // const mockSearchResults = [ ... ];
            // --- ENDE MOCK-DATEN ---

            // Haupt-Initialisierungsfunktion
            function init() {
                // Prüfen, ob ein Token im localStorage gespeichert ist
                const storedToken = localStorage.getItem('spotifyAccessToken');

                if (storedToken) {
                    currentAccessToken = storedToken;
                    // Zeige die Haupt-App und verstecke das Modal
                    appContainer.classList.remove('hidden');
                    tokenModal.classList.add('hidden');
                    // Starte die normale App-Logik
                    initAppLogic();
                } else {
                    // Zeige das Token-Modal, verstecke die App
                    appContainer.classList.add('hidden');
                    tokenModal.classList.remove('hidden');
                    tokenErrorMessage.textContent = "Bitte füge einen Access Token ein, um zu starten.";
                }

                // Event Listener für den Speicher-Button im Modal
                saveTokenBtn.addEventListener('click', () => {
                    const newToken = tokenInput.value.trim();
                    if (newToken) {
                        localStorage.setItem('spotifyAccessToken', newToken);
                        currentAccessToken = newToken;
                        
                        // UI aktualisieren
                        appContainer.classList.remove('hidden');
                        tokenModal.classList.add('hidden');
                        tokenInput.value = ''; // Eingabefeld leeren
                        tokenErrorMessage.textContent = '';
                        
                        // App-Logik starten
                        initAppLogic();
                    } else {
                        tokenErrorMessage.textContent = "Das Feld darf nicht leer sein.";
                    }
                });
            }

            // NEUE Funktion, um die App-Logik zu kapseln
            function initAppLogic() {
                // 1. Prüfen, ob der Song für heute schon hinzugefügt wurde
                if (hasAddedSongToday()) {
                    setLockedState("Du hast deinen Song für heute schon hinzugefügt!");
                } else {
                    setUnlockedState();
                }

                // 2. Event Listener für die Suche (wird nur einmal gesetzt)
                // Stellen sicher, dass der Listener nicht mehrfach hinzugefügt wird
                if (!searchInput.dataset.listenerAttached) {
                     searchInput.addEventListener('input', handleSearchInput);
                     searchInput.dataset.listenerAttached = 'true';
                }
            }


            // --- STATUS- & UI-FUNKTIONEN ---

            // Prüft im localStorage, ob heute ein Song hinzugefügt wurde
            function hasAddedSongToday() {
                const lastAddedDate = localStorage.getItem('songDesTages_lastAdded');
                if (!lastAddedDate) {
                    return false;
                }
                const today = new Date().toDateString();
                return lastAddedDate === today;
            }

            // Setzt den Status auf "Gesperrt"
            function setLockedState(message) {
                statusMessage.textContent = message;
                searchInput.disabled = true;
                searchInput.placeholder = "Bis morgen!";
                contentArea.classList.add('hidden'); // Versteckt Vorschläge/Ergebnisse
            }

            // Setzt den Status auf "Entsperrt"
            function setUnlockedState() {
                statusMessage.textContent = "Wähle deinen Song für den Tag.";
                searchInput.disabled = false;
                searchInput.placeholder = "Suche nach einem Song...";
                contentArea.classList.remove('hidden');
                loadSuggestions(); // Lädt die Vorschläge
            }

            // Zeigt die Vorschläge an
            async function loadSuggestions() {
                // <!-- HIER ERFOLGT DER ECHTE API-AUFRUF: /me/top/tracks?limit=5&time_range=short_term -->
                suggestionsList.innerHTML = ''; // Liste leeren

                if (!currentAccessToken) {
                    handleInvalidToken("Kein Access Token gefunden.");
                    return;
                }

                try {
                    const response = await fetch('https://api.spotify.com/v1/me/top/tracks?limit=5&time_range=short_term', {
                        headers: {
                            'Authorization': `Bearer ${currentAccessToken}`
                        }
                    });

                    if (response.status === 401) {
                        throw new Error("Unauthorized"); // Token abgelaufen
                    }
                    // }); // ENTFERNT: Diese Zeile hat den Syntaxfehler verursacht

                    if (response.status === 401) {
                        throw new Error("Unauthorized: Dein Access Token ist ungültig oder abgelaufen.");
                    }
                    if (!response.ok) {
                        // FEHLERBEHEBUNG: Bessere Fehlerbehandlung, um die JSON-Nachricht von Spotify zu lesen
                        let errorDetails = `Spotify API Fehler (${response.status} ${response.statusText})`;
                        try {
                            const errorBody = await response.json();
                            if (errorBody.error && errorBody.error.message) {
                                errorDetails = errorBody.error.message;
                            }
                        } catch (e) { /* Body war kein JSON oder leer */ }
                        throw new Error(errorDetails);
                    }

                    const data = await response.json();
                    data.items.forEach(track => {
                        const song = {
                            id: track.id,
                            title: track.name,
                            artist: track.artists.map(a => a.name).join(', '),
                            uri: track.uri
                        };
                        suggestionsList.appendChild(createSongListItem(song));
                    });

                } catch (error) {
                    console.error("Fehler beim Laden der Vorschläge:", error);
                    suggestionsList.innerHTML = `<li><p class="text-red-400">Fehler: ${error.message}</p></li>`;
                    // NEU: Bei 401-Fehler das Token-Modal zeigen
                    if (error.message.includes("Unauthorized")) {
                        handleInvalidToken("Dein Token ist abgelaufen. Bitte hol einen neuen.");
                    }
                }
            }

            // --- SUCHE & ERGEBNISSE ---

            let searchTimeout;
            function handleSearchInput(e) {
                const query = e.target.value.trim();
                
                // Debounce: Warte 300ms nach der letzten Eingabe, bevor die Suche startet
                clearTimeout(searchTimeout);
                
                if (query === '') {
                    // Wenn Suche leer ist, Vorschläge anzeigen
                    resultsSection.classList.add('hidden');
                    suggestionsSection.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                // Lade-Spinner anzeigen
                loadingSpinner.classList.remove('hidden');
                suggestionsSection.classList.add('hidden');
                resultsSection.classList.add('hidden');

                searchTimeout = setTimeout(async () => {
                    // <!-- HIER ERFOLGT DER ECHTE API-AUFRUF: /search?q=...&type=track&limit=10 -->
                    console.log(`Suche nach: ${query}`);
                    
                    if (!currentAccessToken) {
                        handleInvalidToken("Kein Access Token gefunden.");
                        return;
                    }

                    try {
                        const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
                            headers: {
                                'Authorization': `Bearer ${currentAccessToken}`
                            }
                        });

                        if (response.status === 401) {
                            throw new Error("Unauthorized"); // Token abgelaufen
                        }
                        if (!response.ok) {
                            // FEHLERBEHEBUNG: Bessere Fehlerbehandlung
                            let errorDetails = `Spotify API Fehler (${response.status} ${response.statusText})`;
                            try {
                                const errorBody = await response.json();
                                if (errorBody.error && errorBody.error.message) {
                                    errorDetails = errorBody.error.message;
                                }
                            } catch (e) { /* Body war kein JSON oder leer */ }
                            throw new Error(errorDetails);
                        }

                        const data = await response.json();
                        // Ergebnisse (echt) anzeigen
                        resultsList.innerHTML = '';
                        data.tracks.items.forEach(track => {
                            const song = {
                                id: track.id,
                                title: track.name,
                                artist: track.artists.map(a => a.name).join(', '),
                                uri: track.uri
                            };
                            resultsList.appendChild(createSongListItem(song));
                        });

                    } catch (error) {
                        console.error("Fehler bei der Suche:", error);
                        resultsList.innerHTML = `<li><p class="text-red-400">Fehler: ${error.message}</p></li>`;
                        // NEU: Bei 401-Fehler das Token-Modal zeigen
                        if (error.message.includes("Unauthorized")) {
                            handleInvalidToken("Dein Token ist abgelaufen. Bitte hol einen neuen.");
                        }
                    }

                    // Lade-Spinner verbergen und Ergebnisse anzeigen
                    loadingSpinner.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                    
                }, 500); // Simuliert eine Netzwerkverzögerung
            }

            // Erstellt ein einzelnes Song-Listen-Element (für Vorschläge ODER Ergebnisse)
            function createSongListItem(song) {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors";
                
                li.innerHTML = `
                    <div>
                        <p class="font-semibold text-white">${song.title}</p>
                        <p class="text-sm text-gray-400">${song.artist}</p>
                    </div>
                    <button class="add-song-btn text-green-400 hover:text-green-300" 
                            data-track-id="${song.id}" 
                            data-track-uri="${song.uri}"
                            data-track-title="${song.title}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                `;

                // Event Listener, um den Song hinzuzufügen
                li.querySelector('.add-song-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Verhindert, dass das LI-Klick-Event ausgelöst wird
                    addSongToPlaylist(song);
                });

                // Klick auf das ganze Element funktioniert auch
                li.addEventListener('click', () => {
                    addSongToPlaylist(song);
                });

                return li;
            }

            // --- SONG HINZUFÜGEN (DER "ZWANG") ---

            async function addSongToPlaylist(song) {
                // Doppelt prüfen, falls der Status sich geändert hat
                if (hasAddedSongToday()) {
                    setLockedState("Du hast deinen Song für heute schon hinzugefügt!");
                    return;
                }

                console.log(`Füge hinzu: ${song.title} (${song.id})`);
                
                if (!currentAccessToken || PLAYLIST_ID === "DEINE_PLAYLIST_ID_HIER") {
                    showToast("Fehler: API-Daten in HTML eintragen!");
                    if (!currentAccessToken) handleInvalidToken("Kein Access Token gefunden.");
                    return;
                }

                // Lade-Spinner anzeigen
                loadingSpinner.classList.remove('hidden');
                contentArea.classList.add('hidden');
                searchInput.disabled = true;

                // <!-- HIER ERFOLGT DER ECHTE API-AUFRUF: 
                //      POST /playlists/{playlist_id}/tracks?uris=spotify:track:${song.id} 
                // -->
                
                try {
                    const response = await fetch(`https://api.spotify.com/v1/playlists/${PLAYLIST_ID}/tracks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            uris: [song.uri] // z.B. "spotify:track:4iV5W9uYEdYUVa79Axb7Rh"
                        })
                    });

                    if (response.status === 401) {
                        throw new Error("Unauthorized"); // Token abgelaufen
                    }
                    if (!response.ok) {
                        // FEHLERBEHEBUNG: Bessere Fehlerbehandlung (Hier trat der Fehler auf)
                        let errorDetails = `Spotify API Fehler (${response.status} ${response.statusText})`;
                        try {
                            // Versuchen, die detaillierte Fehlermeldung von Spotify zu lesen
                            const errorBody = await response.json();
                            if (errorBody.error && errorBody.error.message) {
                                errorDetails = errorBody.error.message;
                            }
                        } catch (e) {
                            // Body war kein JSON oder leer, der ursprüngliche Fehler ist gut genug
                        }
                        throw new Error(errorDetails);
                    }

                    // Erfolg!
                    // 1. Heutiges Datum im localStorage speichern
                    localStorage.setItem('songDesTages_lastAdded', new Date().toDateString());

                    // 2. UI in den "Gesperrt"-Zustand versetzen
                    setLockedState(`"${song.title}" wurde hinzugefügt. Bis morgen!`);
                    
                    // 3. Lade-Spinner verbergen
                    loadingSpinner.classList.add('hidden');

                    // 4. Erfolgs-Toast anzeigen
                    showToast(`"${song.title}" hinzugefügt!`);

                    // 5. Suchfeld leeren
                    searchInput.value = '';

                } catch (error) {
                    console.error("Fehler beim Hinzufügen des Songs:", error);
                    showToast(`Fehler: ${error.message}`);
                    // Zustand zurücksetzen, damit der User es nochmal versuchen kann
                    setUnlockedState(); 
                    contentArea.classList.remove('hidden');
                    searchInput.disabled = false;
                    loadingSpinner.classList.add('hidden');

                    // NEU: Bei 401-Fehler das Token-Modal zeigen
                    if (error.message.includes("Unauthorized")) {
                        handleInvalidToken("Dein Token ist abgelaufen. Bitte hol einen neuen.");
                    }
                }
            }

            function showToast(message) {
                toastMessage.textContent = message;
                toastMessage.classList.remove('hidden');
                setTimeout(() => {
                    toastMessage.classList.add('hidden');
                }, 3000);
            }

            // NEUE Funktion: Zeigt das Modal an und löscht den alten Token
            function handleInvalidToken(errorMessage) {
                console.error("handleInvalidToken aufgerufen:", errorMessage);
                // Alten Token löschen
                localStorage.removeItem('spotifyAccessToken');
                currentAccessToken = null;

                // UI zurücksetzen
                appContainer.classList.add('hidden');
                tokenModal.classList.remove('hidden');
                tokenErrorMessage.textContent = errorMessage;
            }

            // App starten
            init();
        });
    </script>
</body>
</html>
